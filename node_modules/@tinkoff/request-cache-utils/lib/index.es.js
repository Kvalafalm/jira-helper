import prop from '@tinkoff/utils/object/prop';
import { Status } from '@tinkoff/request-core';

const CACHE = 'cache';

var metaTypes = {
    __proto__: null,
    CACHE: CACHE
};

var shouldCacheExecute = (name, dflt) => (context) => {
    var _a, _b, _c, _d;
    const request = context.getRequest();
    const forced = (_a = prop('cacheForce', request)) !== null && _a !== void 0 ? _a : false;
    const forcedSpecific = (_b = prop(`${name}CacheForce`, request)) !== null && _b !== void 0 ? _b : forced;
    const enabled = (_c = prop('cache', request)) !== null && _c !== void 0 ? _c : dflt;
    const enabledSpecific = (_d = prop(`${name}Cache`, request)) !== null && _d !== void 0 ? _d : enabled;
    if (context.getStatus() === Status.INIT) {
        context.updateExternalMeta(CACHE, {
            forced,
            enabled,
            [`${name}Enabled`]: enabledSpecific,
            [`${name}Force`]: forcedSpecific,
        });
    }
    if (forcedSpecific) {
        return context.getStatus() === Status.COMPLETE;
    }
    return enabledSpecific;
};

var defaultCacheKey = ({ httpMethod = 'GET', url, payload, query, rawQueryString = '', additionalCacheKey = '' }) => httpMethod.toLowerCase() +
    url +
    JSON.stringify(payload || '') +
    JSON.stringify(query || '') +
    rawQueryString +
    JSON.stringify(additionalCacheKey);

var getCacheKey = (context, cacheKey = defaultCacheKey) => {
    let key = prop('key', context.getInternalMeta(CACHE));
    if (!key) {
        key = cacheKey(context.getRequest());
        context.updateInternalMeta(CACHE, {
            key,
        });
    }
    return key;
};

export { defaultCacheKey as cacheKey, getCacheKey, metaTypes, shouldCacheExecute };
